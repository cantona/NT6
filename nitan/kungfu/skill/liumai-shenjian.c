#include <ansi.h>
inherit SKILL;

mapping *action = ({
([      "name":   "少商劍",
        "action": "$N雙手拇指同時捺出，嗤嗤兩聲急響，「" HIW "少商劍" NOR "」有如石破"
                  "天驚、風雨大至",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少商劍",
        "action": "$N大拇指一按，嗤嗤兩指，勁道使得甚巧，「" HIW "少商劍" NOR "」劍氣"
                  "如怒潮般湧至",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少商劍",
        "action": "$N大拇指連揮，「" HIW "少商劍" NOR "」便如是一幅潑墨山水，縱橫倚斜"
                  "，劍路雄勁",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少商劍",
        "action": "$N雙手拇指同時捺出，「" HIW "少商劍" NOR "」大開大闔，氣派宏偉，每"
                  "一劍都有風雨大至之勢",
        "force" : 460,
        "attack": 140,
        "dodge" : 90,
        "parry" : 90,
        "damage": 260,
        "weapon" : HIW "少商劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "商陽劍",
        "action": "$N食指連動，手腕園轉，「" HIW "商陽劍" NOR "」一劍又一劍的刺出，輕"
                  "靈迅速，劍氣縱橫",
        "force" : 440,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商陽劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "商陽劍",
        "action": "$N變招奇速，右手食指疾從袖底穿出，「" HIW "商陽劍" NOR "」登時幻出"
                  "無數指影",
        "force" : 440,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商陽劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "商陽劍",
        "action": "$N拇指一屈，食指隨即點出，嗤嗤兩聲急響，變成商陽劍法，「" HIW "商"
                  "陽劍" NOR "」激射刺出",
        "force" : 440,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商陽劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "商陽劍",
        "action": "$N以食指急運「" HIW "商陽劍" NOR "」之無形劍氣，卻不過是手指在數寸"
                  "范圍內一點一戳",
        "force" : 480,
        "attack": 145,
        "dodge" : 110,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "商陽劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "中沖劍",
        "action": "$N右手中指一豎，「" HIW "中沖劍" NOR "」向前刺出。真氣鼓盪，嗤然聲"
                  "響，無形劍氣直指$n",
        "force" : 560,
        "attack": 155,
        "dodge" : 10,
        "parry" : 70,
        "damage": 220,
        "weapon" : HIW "中沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "中沖劍",
        "action": "$N將中指向上一刺，「" HIW "中沖劍" NOR "」拔地而起，接著手指向下一"
                  "劃，劍氣如利刀般砍出",
        "force" : 560,
        "attack": 145,
        "dodge" : 10,
        "parry" : 70,
        "damage": 220,
        "weapon" : HIW "中沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "中沖劍",
        "action": "電光火石之間，$N猛然翻掌，右手陡然探出，中指「" HIW "中沖劍" NOR
                  "」向$n一豎",
        "force" : 560,
        "attack": 135,
        "dodge" : 10,
        "parry" : 70,
        "damage": 220,
        "weapon" : HIW "中沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "關沖劍",
        "action": "$N右手無名指伸出，「" HIW "關沖劍" NOR "」劍路拙滯古樸，一股雄渾無"
                  "比的內力鼓盪而出",
        "force" : 530,
        "attack": 140,
        "dodge" : 100,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "關沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "關沖劍",
        "action": "$N俯身斜倚，無名指「" HIW "關沖劍" NOR "」彈射而出，指尖已對準$n發"
                  "出了一縷強烈的勁風",
        "force" : 530,
        "attack": 140,
        "dodge" : 100,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "關沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "關沖劍",
        "action": "$N無名指輕輕一揮，「嗤啦」一聲，拙滯古樸的「" HIW "關沖劍" NOR "」"
                  "劍氣向$n直射而出",
        "force" : 530,
        "attack": 140,
        "dodge" : 100,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "關沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少澤劍",
        "action": "$N左手小指一伸，一條氣流從少沖穴中激射而出，「" HIW "少澤劍" NOR
                  "」出手入風，指向$n",
        "force" : 500,
        "attack": 160,
        "dodge" : 95,
        "parry" : 92,
        "damage": 270,
        "weapon" : HIW "少澤劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少澤劍",
        "action": "忽見$N左手小指一伸，一條氣流從$P少沖穴中激射而出，一股「" HIW "少"
                  "澤劍" NOR "」登時射向$n",
        "force" : 500,
        "attack": 160,
        "dodge" : 95,
        "parry" : 92,
        "damage": 270,
        "weapon" : HIW "少澤劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少沖劍",
        "action": "$N右手小指伸出，真氣自少沖穴激盪而出，「" HIW "少沖劍" NOR "」橫生"
                  "奇變，颼的刺向$n",
        "force" : 480,
        "attack": 150,
        "dodge" : 90,
        "parry" : 95,
        "damage": 240,
        "weapon" : HIW "少沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少沖劍",
        "action": "$N掌托于胸前，伸出右小指，一招「" HIW "少沖劍" NOR "」緩緩地點向$n"
                  "的周身大穴",
        "force" : 530,
        "attack": 170,
        "dodge" : 90,
        "parry" : 95,
        "damage": 260,
        "weapon" : HIW "少沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少沖劍",
        "action": "$N小指一彈，「" HIW "少沖劍" NOR "」化式「分花拂柳」，劍勢如同柳絮"
                  "一般，飄而不亂",
        "force" : 430,
        "attack": 180,
        "dodge" : 90,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "少沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少沖劍",
        "action": "$N一招「" HIW "少沖劍" NOR "」，劍氣回轉無定形，竟從左側繞了過來，"
                  "點向$n",
        "force" : 530,
        "attack": 180,
        "dodge" : 90,
        "parry" : 95,
        "damage": 240,
        "weapon" : HIW "少沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
([      "name":   "少沖劍",
        "action": "$N右手小指一揮，一招「" HIW "少沖劍" NOR "」點點刺刺破空刺出，宛如"
                  "雕花刺畫一般",
        "force" : 530,
        "attack": 180,
        "dodge" : 90,
        "parry" : 95,
        "damage": 280,
        "weapon" : HIW "少沖劍氣" NOR,
        "damage_type":  "刺傷"
]),
});

string main_skill()
{
        return "liumai-shenjian";
}

mapping sub_skills = ([
        "shaoshang-sword"  : 180,
        "shangyang-sword"  : 180,
        "zhongchong-sword" : 180,
        "guanchong-sword"  : 180,
        "shaoze-sword"     : 180,
        "shaochong-sword"  : 180,
]);

int get_ready(object me)
{
        tell_object(me, "你無法演練此六脈神劍。\n");
        return 0;
        // return 1;
}

int get_finish(object me)
{
          if( query("int", me)<32 )
        {
                tell_object(me, "你演練完畢，只感六種劍法毫無牽連，看來依你的悟性，無"
                                "法將其合一。\n");
                return 0;
        }

          if( query("con", me)<26 )
        {
                tell_object(me, "你演練完畢，只覺全身真氣亂竄，眼冒金星，兩耳轟鳴，好"
                                "不容易才控制下來。\n");
                return 0;
        }

        if( !query("family/family_name", me) || 
            query("family/family_name", me) != "段氏皇族" )
                    return notify_fail("你研究了一會兒，只覺的不是段氏皇族的根本無法理解其中奧妙\n");  

        if( query("gender", me) == "無性" )
                return notify_fail("你無根無性，陰陽不調，難以演練六脈神劍。\n");

        if (me->query_skill("literate", 1) < 200)
        {
                tell_object(me, "你覺得六脈神劍極其深奧，看來多研究一下學問可能更有幫"
                                "助。\n");
                return 0;
        }

        if (me->query_skill("lamaism", 1) < 200)
        {
                tell_object(me, "你演練完畢，發現如果通曉密宗心法應該更有幫助。\n");
                return 0;
        }

        if (me->query_skill("buddhism", 1) < 200)
        {
                tell_object(me, "你演練完畢，發現如果通曉禪宗心法應該更有幫助。\n");
                return 0;
        }

        if (me->query_skill("jingluo-xue", 1) < 200)
        {
                tell_object(me, "你演練完畢，發現如果通曉經絡學應該更有所幫助。\n");
                return 0;
        }

        if( query("max_neili", me)<5000 )
        {
                tell_object(me, "你覺得真氣不繼，無法融會貫通六劍。\n");
                return 0;
        }
   
        if ((int)me->query_skill("martial-cognize", 1) < 200)
        {
                tell_object(me, "你演練完畢，發現如果武學修養更上一層因該更有所幫助。\n");
                return 0;           
        }

        if ((int)me->query_skill("force", 1) < 340)
        {
                tell_object(me, "你演練完畢，發現自己內功根基太差，無法再繼續演練下去。\n");
                return 0;           
        }

        if (random(10) < 7)
        {
                tell_object(me, "你覺得有所感悟，或許再演練一次就能融會貫通，練成六脈"
                                "神劍。\n");
                return 0;
        }

        tell_object(me, HIY "一陣凡塵往事湧上心頭，你幾欲放聲長嘆。眼前不斷閃現出六脈"
                            "劍法，\n霎那間，你終于通曉六脈神劍。\n" NOR);
        return 1;
}

mapping query_sub_skills()
{
        return sub_skills;
}

int valid_enable(string usage)
{
        return usage == "finger" || usage == "parry";
}

int double_attack()
{
        return 1;
}

int valid_learn(object me)
{
        if( query_temp("weapon", me) || query_temp("secondary_weapon", me) )
                return notify_fail("練六脈神劍必須空手。\n");

          if( query("int", me)<32 )
                return notify_fail("你研究了半天，只感六種劍法毫無牽連，無法再作研究。\n");

          if( query("con", me)<26 )
                return notify_fail("你研究了一會兒，只覺得眼前金星亂冒，太陽穴突突的跳。\n");

        if (me->query_skill("literate", 1) < 200)
                return notify_fail("你覺得六脈神劍極其深奧，不是你這種學問水平所能研究的。\n");

        if (me->query_skill("lamaism", 1) < 200)
                return notify_fail("你發現這裡面有很多奧妙都和密宗心法有關，難以理解。\n");

        if (me->query_skill("buddhism", 1) < 200)
                return notify_fail("你發現這裡面有很多奧妙都和禪宗心法有關，難以理解。\n");

        if (me->query_skill("jingluo-xue", 1) < 200)
                return notify_fail("你發現這裡面有很多奧妙都和人體的經絡構造有關，難以理解。\n");

        if( query("max_neili", me)<5000 )
                return notify_fail("你的內力太弱，無法學六脈神劍。\n");

        if ((int)me->query_skill("finger", 1) < 200)
                return notify_fail("你的基本指法火候不夠。\n");

        if ((int)me->query_skill("force", 1) < (int)me->query_skill("liumai-shenjian", 1) + 10)
                return notify_fail("你的現在必須先提高你基本內功的水平。\n");

        if ((int)me->query_skill("finger", 1) < (int)me->query_skill("liumai-shenjian", 1) + 10)
                return notify_fail("你的現在必須先提高你基本指法的水平。\n");

        return 1;
}

string query_skill_name(int level)
{
        int i;
        for(i = sizeof(action); i > 0; i--)
                if(level >= action[i-1]["lvl"])
                        return action[i-1]["skill_name"];
}

int practice_skill(object me)
{
        int cost;

        if( query("qi", me)<100 )
                return notify_fail("你的體力太低了。\n");

        cost = me->query_skill("liumai-shenjian", 1) / 2 + 160;

        if( query("neili", me)<cost )
                return notify_fail("你的內力不夠練六脈神劍。\n");

        me->receive_damage("qi", 88);
        addn("neili", -cost, me);
        return 1;
}

mixed hit_ob(object me, object victim, int damage_bonus, int i, int attack_time)
{
        string name;

        if (userp(me))
                attack_time = (int)(me->query_skill("liumai-shenjian", 1) / 50);
        else
                attack_time = (int)(me->query_skill("liumai-shenjian", 1) / 25);

        // 放寬NPC的攻擊力度
        if (userp(me) && attack_time > 6)
                attack_time = 6;

        if (! me->is_busy()
           && living(victim)
           && damage_bonus > 120
            && query("neili", me)>400
            && query_temp("action_flag", me) != 0
           && me->query_skill("martial-cognize", 1) >= 220
           && me->query_skill("liumai-shenjian", 1) >= 180
           && me->query_skill("jingluo-xue", 1) >= 200)
        {
                if (userp(me) && random(3) != 1)
                                return 0;

                // 避免在使用Pfm時訊息重復
                if( userp(me) && !query_temp("liumai-shenjian/hit_msg", me) )
                        message_vision(HIW "\n霎時間$N" HIW "只覺思緒狂湧，六脈劍譜中"
                                       "的六路劍法交替展現，登時十指紛彈，此去彼來，連"
                                       "綿無盡。\n" NOR, me, victim);

                if (userp(me))
                        me->start_busy(2 + random(attack_time));
                    else
                        me->start_busy(1);

                       addn("neili", -attack_time*50, me);

                for (i = 0; i < attack_time; i++)
                {
                        if (! me->is_fighting(victim))
                                break;
                        COMBAT_D->do_attack(me, victim, 0, 0);
                }
        }

           if (damage_bonus / 5 > victim->query_dex()
               && damage_bonus > 150
            && query("neili", me)>200
           && me->query_skill("martial-cognize", 1) >= 220
           && me->query_skill("liumai-shenjian", 1) >= 160
           && me->query_skill("jingluo-xue", 1) >= 180)
        {
                addn("neili", -50, me);
                victim->receive_wound("qi", (damage_bonus - 80) / 2, me);
                return random(2) ? HIR "你聽到「嗤啦」一聲輕響，臉上竟飛濺到了一些血滴"
                                   "！\n" NOR:

                                   HIR "你只聽「噗嗤」一聲輕響，一股血柱至$n" HIR "身上"
                                   "濺出！\n" NOR;
        }
        return 1;
}

mapping query_action(object me, object weapon)
{
        if( !undefinedp(query_temp("six-action", me)) )
                return action[query_temp("six-action", me)];

        if( random(15) == 1 && query("neili", me)>600 )
        {
                addn("neili", -300, me);
                return ([       "action": "$N縱身前撲，雙手拇指同時按出一記「" HIR "少商劍" NOR
                                          "」，兩道無形劍氣破空而出逼向$n",
                                        "attack": 300,
                                "dodge" : 200,
                                "parry" : 200,
                                "damage": 300,
                                "force" : 600,
                                "weapon" : HIR "破體無形劍氣" NOR,
                                "damage_type": "刺傷"
                        ]);
        } else
        if( random(15) == 1 && query("neili", me)>600 )
        {
                addn("neili", -300, me);
                return ([       "action": "$N雙手手指急速彈動，頓時「" HIR "商陽劍" NOR "」和「"
                                          HIR "中沖劍" NOR "」兩路劍法齊施，劍氣源源不斷湧向$n",
                                        "attack": 300,
                                "dodge" : 200,
                                "parry" : 200,
                                "damage": 300,
                                "force" : 600,
                                "weapon" : HIR "破體無形劍氣" NOR,
                                "damage_type": "刺傷"
                        ]);
        } else
        if( random(15) == 1 && query("neili", me)>1000 )
        {
                addn("neili", -300, me);
                return ([       "action": "$N內息急轉，不斷催動真氣，「" HIR "六脈神劍" NOR "」"
                                          "奧妙無方，劍氣破空之聲驟響，盡數襲向$n",
                                        "attack": 300,
                                "dodge" : 200,
                                "parry" : 200,
                                "damage": 300,
                                "force" : 600,
                                "weapon" : HIR "破體無形劍氣" NOR,
                                "damage_type": "刺傷"
                        ]);
        }
        return action[random(sizeof(action))];
}

string query_parry_msg(object victim_weapon)
{
        switch (random(4))
        {
        case 0:
                return "$n隨意揮洒，道道劍氣縱橫交錯，宛若天網，$N唯有望洋興嘆，徒呼奈何。\n";
        case 1:
                return "$n不閃不避，一招中沖劍直襲$N的胸前大穴，迫得$N只有回身自救。\n";
        case 2:
                return "$n六劍連出，劍氣回盪，直割得$N眉毛削落，臉面生通，再也不能前進半分！\n";
        default:
                return "$n一聲長笑，無形劍氣四處散開，將$N層層裹住，惟有勉強支撐。才約略擺脫了$n的反擊。\n";
        }
}

void skill_improved(object me)
{
        int i;
        string *sub_skillnames;

        sub_skillnames = keys(sub_skills);

        for (i = 0; i < sizeof(sub_skillnames); i++)
                me->delete_skill(sub_skillnames[i]);
}

string perform_action_file(string action)
{
        return __DIR__"liumai-shenjian/" + action; 
}