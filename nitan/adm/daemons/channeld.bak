// This program is a part of NT MudLIB
// channeld.c
// Written by Lonely@nitan.org

// å°äºåƒæ•¸çš„è§£é‡‹
// msg_speak   æ¨™æº–èªªè©±çš„é¡Œé ­
// msg_emote   å‹•ä½œèªªè©±çš„æé ­ï¼Œä¸å®šç¾©å‰‡è¡¨ç¤ºä¸èƒ½ç”¨å‹•ä½œ
// msg_color   é »é“çš„é¡è‰²
// name        é »é“çš„åç¨±
// only        æŒ‡å®šæ¥å—ä¿¡æ¯çš„ç©å®¶é¡å‹
//             sys    :  ç³»çµ±å¯ä»¥ä½¿ç”¨çš„ï¼Œç©å®¶éƒ½å¯ä»¥çœ‹åˆ°ï¼Œä½†ç©å®¶ä¸å¯ä»¥ä½¿ç”¨
//             wiz    :  appä»¥ä¸Šå¯ä»¥ä½¿ç”¨åŠçœ‹åˆ°
//             arch   :  archä»¥ä¸Šå¯ä»¥ä½¿ç”¨åŠçœ‹åˆ°
//             party  :  å¹«æ´¾å…§éƒ¨ä½¿ç”¨åŠçœ‹åˆ°ï¼ˆå·«å¸«å’ŒæŒ‡å®šå¯ä»¥æ”¶çœ‹æ‰€æœ‰é »é“çš„IDå¯ä»¥çœ‹åˆ°ï¼‰
//             family :  é–€æ´¾å…§éƒ¨ä½¿ç”¨åŠçœ‹åˆ°ï¼ˆå·«å¸«å’ŒæŒ‡å®šå¯ä»¥æ”¶çœ‹æ‰€æœ‰é »é“çš„IDå¯ä»¥çœ‹åˆ°ï¼‰
//             league :  åŒç›Ÿæ´¾å…§éƒ¨ä½¿ç”¨åŠçœ‹åˆ°ï¼ˆå·«å¸«å’ŒæŒ‡å®šå¯ä»¥æ”¶çœ‹æ‰€æœ‰é »é“çš„IDå¯ä»¥çœ‹åˆ°ï¼‰
// name_raw    è¨­ç½®ç‚º1çš„è©±ï¼Œè©²é »é“åœ¨ç©å®¶æˆ´é¢å…·å¾Œä»ç„¶å–å…¶çœŸå¯¦å§“å
// need_age    è¨­ç½®ç‚º1çš„è©±ï¼Œè©²é »é“åœ¨ç©å®¶18æ­²ä¹‹å‰ç„¡æ³•ä½¿ç”¨
// omit_log    è¨­ç½®ç‚º1çš„è©±ï¼Œä¸è¨˜éŒ„èŠå¤©è¨˜éŒ„
// filter      æŒ‡å®šæ¢ä»¶çš„æ¥æ”¶é¡å‹
// for_listen  ç©å®¶åªå¯ä»¥çœ‹åˆ°è€Œä¸å¯ä»¥ä½¿ç”¨

#pragma optimize
#pragma save_binary

#include <ansi.h>
#include <mudlib.h>
#include <net/dns.h>
#include <net/macros.h>
#include <localtime.h>

inherit F_DBASE;

#define ALLOW_LIST ({ })
#define SPECIAL_NPC     ({ "/adm/npc/youxun" })

#define REMOTE_Q    "/adm/daemons/network/services/remote_q.c"

string remove_addresses(string, int all);
int filter_listener(object ppl, string only, object me);
protected int check_bad_words(object user, string msg);

nosave string msg_log;
nosave int log_from;

string *bad_words = ({
       "æ—¥ä½ ", "æ“ä½ ", "å¹¹ä½ ", "æ—¥æ­»", "æ“æ­»", "å¹¹æ­»", "ç‹—æ—¥", "æ—¥å‡ºä¾†",
       "riä½ ", "caoä½ ", "ganä½ ", "riæ­»", "caoæ­»", "ganæ­»", "ç‹—ri", "riå‡ºä¾†",
       "æˆ‘æ“", "fuck", "é›å·´", "è‚›é–€", "æ€§äº¤", "ç•œç”Ÿ", "å¼·å§¦",
       "è‚›äº¤", "æ³•è¼ªåŠŸ","æ’æ­»", "å¹¹å‡ºä¾†", "ganå‡ºä¾†", "ç‹—å¨˜", "é›œç¨®", "è‡ªæ…°",
       "æ¯ç‹—", "ç¥–å®—åå…«", "åª½çš„å€‹é€¼","åª½çš„é€¼", "åª½å€‹é€¼",
       "åª½é€¼", "é€¼é¤Šçš„", "å°é€¼", "åª½çš„å€‹b", "åª½çš„b", "åª½å€‹b", "åª½b", "é¨·è²¨",
       "bé¤Šçš„", "ä½ åª½ç”Ÿ", "é™°é“", "é™°æˆ¶", "é™°è’‚", "é™°è–", "é¾œé ­",
       "åµè›‹", "ç‹—å¨˜", "çƒé¾œç‹å…«", "å‚»é€¼", "å‚»b", "sb", "åšæ„›", "æ„æ·«",
       "è¼ªå§¦", "é›œäº¤", "åª½åª½çš„", "bitch", "æ€§æ„›", "â–¡", "â–¡", "å¦£",
       "â–¡", "å°»", "â–¡", "åŠä½ ", "å¼“é›–å¥³å¹¹"
});

string query_msg_log() { return msg_log; }

mapping channels = ([
        "sys":  ([      "msg_speak": HIR "ã€ç³»çµ±å ±å‘Šã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIR "ã€ç³»çµ±å ±å‘Šã€‘%s" NOR,
                        "msg_color": HIR,
                        "only"     : "imm",
                        "name"     : "ç³»çµ±",
                        "omit_log" : 1,
                        "name_raw" : 1,
                ]),

        "wiz":  ([      "msg_speak": HIG "ã€å·«å¸«é »é“ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIG "ã€å·«å¸«é »é“ã€‘%s" NOR,
                        "msg_color": HIG,
                        "name"     : "å·«å¸«",
                        "only"     : "imm",
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "wiz",
                        "omit_address": 0,
                        "omit_log" : 1,
                        "name_raw" : 1,
                        "filter"   : (: $1["MUDLIB"] == MUDLIB_NAME :)
                ]),

        "gwiz": ([      "msg_speak": HIG "ã€ç¶²éš›å·«å¸«ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIG "ã€ç¶²éš›å·«å¸«ã€‘%s" NOR,
                        "msg_color": HIG,
                        "name"     : "äº¤æµ",
                        "only"     : "imm",
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "gwiz",
                        "omit_address"     : 0,
                        "omit_log" : 1,
                        "name_raw" : 1,
                        //"filter"   : 1,
                ]),

        "debug":([      "msg_speak": HIW "ã€èª¿è©¦ä¿¡æ¯ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIW "ã€èª¿è©¦ä¿¡æ¯ã€‘%s" NOR,
                        "msg_color": HIW,
                        "name"     : "èª¿è©¦",
                        "only"     : "wiz",
                        "omit_log" : 1,
                        "name_raw" : 1,
                ]),

        "war": ([       "msg_speak": HIR "ã€æˆ°çˆ­é »é“ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIR "ã€æˆ°çˆ­é »é“ã€‘%s" NOR,
                        "msg_color": HIR,
                        "name"     : "ä»»å‹™",
                        //"only"     : "npc",
                        "omit_log" : 1,
                        "name_raw" : 1,
                ]),

        "inter":([      "msg_speak": HIR "ã€åŒç›Ÿäº¤è«‡ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIR "ã€åŒç›Ÿäº¤è«‡ã€‘%s" NOR,
                        "msg_color": HIR,
                        "only"     : "league",
                        "name_raw" : 1,
                        "name"     : "åŒç›Ÿ",
                        "omit_log" : 1,
                ]),

        "chat": ([      "msg_speak": HIC "ã€è«–é“æ±Ÿæ¹–ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIC "ã€è«–é“æ±Ÿæ¹–ã€‘%s" NOR,
                        "msg_color": HIC,
                        "name"     : "é–’èŠ",
                ]),

        "new": ([       "msg_speak": HIC+"ã€"+HIW+"åˆå…¥æ±Ÿæ¹–"+HIC+"ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": CYN+"ã€"+HIY+"åˆå…¥æ±Ÿæ¹–"+CYN+"ã€‘"+HIC+"%s" NOR,
                        "msg_color": NOR+HIC,
                        "name"     : "æ–°æ‰‹",

                ]),

        "rumor":([      "msg_speak": HIM "ã€è¬ è¨€å››èµ·ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIM "ã€è¬ è¨€å››èµ·ã€‘%s" NOR,
                        "msg_color": HIM,
                        "name"     : "è¬ è¨€",
                        "anonymous": "æŸäºº",
                ]),

        "ultra": ([     "msg_speak": HIW "ã€å¤§ å®— å¸«ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIW "ã€å¤§ å®— å¸«ã€‘%s" NOR,
                        "msg_color": HIW,
                        "name"     : "å¤§å®—å¸«",
                        "intermud" : GCHANNEL,
                        "intermud_emote"    : 1,
                        "intermud_channel"  : "rultra",
                        "filter"   : (: $1["MUDLIB"] == MUDLIB_NAME :)
                ]),

        "info": ([      "msg_speak": WHT "ã€ä¿¡æ¯é »é“ã€‘%sï¼š%s\n" NOR,
                        "msg_color": WHT,
                        "name"     : "ä¿¡æ¯",
                        //"only"     : "sys",
                        "omit_log" : 1,
                        "for_listen": 1,
                ]),

        "shout":([      "msg_speak": HIW "%sç¸±è²é•·å˜¯ï¼š%s\n" NOR,
                ]),

        "sing":  ([     "msg_speak": CYN "ã€æ­¡æ­Œç¬‘èªã€‘%så”±è‘—ï¼š%s\n" NOR,
                        "msg_color": CYN,
                        "name"     : "æ­Œå”±",
                 ]),
        "stock":([      "msg_speak": RED "ã€è‚¡ç¥¨é »é“ã€‘%sï¼š%s\n" NOR,
                        "msg_color": RED,
                        "name"     : "è‚¡ç¥¨",
                        //"only"     : "sys",
                        "omit_log" : 1,
                        "for_listen": 1,
                ]),

        "sos":  ([      "msg_speak": HIG "ã€æ±Ÿæ¹–å‘Šæ€¥ã€‘%sï¼š%s\n" NOR,
                        "msg_color": HIG,
                        "name_raw" : 1,
                        "name"     : "æ±‚åŠ©",
                ]),

        "family":([     "msg_speak": HIG "ã€åŒé–€è©±èªã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIG "ã€åŒé–€è©±èªã€‘%s" NOR,
                        "msg_color": HIG,
                        "only"     : "family",
                        "name"     : "åŒé–€",
                        "omit_log" : 1,
                ]),

        "party":([      "msg_speak": HIG "ã€æœ¬å¹«è©±èªã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIG "ã€æœ¬å¹«è©±èªã€‘%s" NOR,
                        "msg_color": HIG,
                        "only"     : "party",
                        "name"     : "å¹«æ´¾",
                        "omit_log" : 1,
                ]),

        "bt":([         "msg_speak": HIG "ã€æˆ°å ´è©±èªã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIG "ã€æˆ°å ´è©±èªã€‘%s" NOR,
                        "msg_color": HIG,
                        "only"     : "bt",
                        "name"     : "æˆ°å ´",
                        "omit_log" : 1,
                ]),
                
        "rultra":([     "msg_speak": WHT "ã€å¡å¤–å®—å¸«ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": WHT "ã€å¡å¤–å®—å¸«ã€‘%s" NOR,
                        "msg_color": WHT,
                        "name"     : "å¡å¤–å®—å¸«",
                        "for_listen": 1,
                ]),

        "nt":   ([      "msg_speak": HIC "ã€ç•°åŸŸå‚³èã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIC "ã€ç•°åŸŸå‚³èã€‘%s" NOR,
                        "msg_color": HIC,
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "nt",
                        "name"     : "ç•°åŸŸ",
                        "name_raw" : 1,
                        "filter"   : (: $1["MUDLIB"] == MUDLIB_NAME :)
                ]),

        "es":   ([      "msg_speak": HIC "ã€ç¶²éš›å‚³æƒ…ã€‘%sï¼š%s\n" NOR,
                        "msg_emote": HIC "ã€ç¶²éš›å‚³æƒ…ã€‘%s" NOR,
                        "msg_color": HIC,
                        "intermud" : GCHANNEL,
                        "intermud_emote"   : 1,
                        "intermud_channel" : "es",
                        "name"     : "ç¶²éš›",
                        //"filter"   : 1,
                        // "need_age" : 1,
                        "name_raw" : 1,
                        "omit_address"     : 0,
                 ]),

        "bill":  ([     "msg_speak": HIY "ã€äº¤æ˜“é »é“ã€‘%sï¼š%s\n" NOR,
                        "msg_color": HIY,
                        "name"     : "äº¤æ˜“",
                        "name_raw" : 1,
                        "omit_log" : 1,
                 ]),

]);

void create()
{
        // This is required to pass intermud access check.
        seteuid(getuid());
        set("channel_id", "é »é“ç²¾éˆ");
}

mapping query_chann() {        return channels; }

void channel_log(string msg, string verb, object user)
{
        string lfn;
        mixed lt;
        int t;

        if( !mapp(channels[verb]) || !objectp(user) || !userp(user) )
                return;

        if( channels[verb]["omit_log"] )
                return;

        if( !stringp(msg_log) ) msg_log = "";

        t = time();
        msg_log += sprintf(" %s(%s) on %s\n%s",
                           user->name(1),query("id", user),log_time(),filter_color(msg));
        if( strlen(msg_log) > 8000 || t - log_from > 900 ) {
                lt = localtime(t);

                lfn = sprintf("channel/%d-%d-%d", lt[LT_YEAR],
                              lt[LT_MON] + 1, lt[LT_MDAY]);
                assure_file(LOG_DIR + lfn);
                log_file(lfn, msg_log);
                msg_log = "";
                log_from = t;
        }
}

// æ¥æ”¶REMOTE_Qè¿”å›ä¾†çš„ä¿¡æ¯ä¸¦é¡¯ç¤ºä¹‹
void do_remote_channel(object me, string verb, string arg)
{
        object *obs;
        string msg;

        if( undefinedp(channels[verb]) || !userp(me) )
                return;

        // Ok, I will direct send the message to those people listening us.
        obs = all_interactive();
        if( stringp(channels[verb]["only"]) )
                obs = filter_array(obs, (: filter_listener :),
                                   channels[verb]["only"], me);

        msg = sprintf(channels[verb]["msg_emote"], arg);
        message("channel:" + verb, msg, obs);
        channel_log(msg, verb, me);
        obs->add_msg_log(verb, msg + "\n");

        // å‘å„å€‹ç«™é»ç™¼é€EMOTEä¿¡æ¯
        channels[verb]["intermud"]->send_msg(channels[verb]["intermud_channel"],
                                             query("id", me),me->name(1),
                                             arg, 1,
                                             channels[verb]["filter"]);
}


varargs int do_channel(object me, string verb, string arg, int emote)
{
        object *obs;
        string *tuned_ch, who;
        int is_player, myemote;
        string imsg = 0, local;
        string msg;
        object *tobs;
        object tplayer;
        object *pobs;

        string bt;
        string party;
        string family;
        string fname;

        string self_emote;

        self_emote = arg;

        // Check if this is a channel emote.
        if( sizeof(verb) > 2 ) {
                if( verb[sizeof(verb)-1] == '*' ) {
                        emote = 1;
                        verb = verb[0..<2];
                } else
                if( verb[sizeof(verb)-1] == '#' ) {
                        myemote = 1;
                        verb = verb[0..<2];
                }
        }

        if( !wizardp(me) && arg && strlen(arg) > 350 ) {
                CHANNEL_D->do_channel(this_object(),"sys",query("name", me)+"("+query("id", me)+")ä¼åœ–Floodæ¯€å£å…¬å…±é »é“ï¼\n");
                return 1;
        }

        // Check if this is a channel messsage.
        if( !mapp(channels) || undefinedp(channels[verb]) ) return 0;

        if( me->is_chatter() )
                return notify_fail("èŠå¤©é­‚é­„ç›®å‰ä¸èƒ½ä½¿ç”¨å„ç¨®é »é“ã€‚\n");

        is_player = playerp(me);
        if( is_player && ! wizardp(me) ) {
//if( !query("registered", me) )
//                        return notify_fail("ä½ å¿…é ˆåœ¨æ³¨å†Šä»¥å¾Œæ‰èƒ½å¤ ä½¿ç”¨å„ç¨®é »é“ã€‚\n");

//query("mud_age", if( me)1800 && me-query("monfee")<11 )
//                        return notify_fail("ä½ å¿…é ˆåœ¨å®Œæˆæ³¨å†Šäº”åˆ†é˜ä»¥å¾Œæ‰èƒ½ä½¿ç”¨é »é“ï¼Œé€™æ®µ"
//                                           "æ™‚é–“å…§è«‹å…ˆé–±è®€å¹«åŠ©(help newbie)ã€‚\n")

                if( channels[verb]["need_age"] && query("age", me)<18 )
                        return notify_fail("ä½ å¿…é ˆæˆå¹´ä»¥å¾Œæ‰èƒ½ä½¿ç”¨" + channels[verb]["name"] +
                                           "é »é“ã€‚\n");
        }

        //now we can be sure it's indeed a channel message:
        if( !stringp(arg) || arg == "" || arg == " " )
                arg = "...";

        if( ultrap(me) ) {
                if( verb == "chat" && ! query("env/no_autoultra", me) )
                        verb = "ultra";
        } else
                if( is_player && verb == "ultra" )
                        return notify_fail("ç­‰ä½ æˆäº†å¤§å®—å¸«å†"
                                           "ä½¿ç”¨é€™å€‹é »é“å§ï¼\n");

        // player broadcasting need consume jing
        if( playerp(me) && !wizardp(me) && verb == "rumor" &&
            !objectp(present("rumor generator", me)) )
                if( query("jing", me)>50)me->add("jing",-random(36) )
                        ; else
                return notify_fail("ä½ å·²ç¶“æ²’åŠ›æ°£æ•£æ’­è¬ è¨€äº†ï¼\n");

        if( playerp(me) && me->ban_say(1) ) return 0;

        // check if rumor or chat is blocked
        if( query("chblk_on", me) )
                return notify_fail("ä½ çš„èŠå¤©é »é“çµ¦é—œé–‰äº†ï¼å”¯ä¸€çš„è¾¦æ³•å°±æ˜¯è«‹æ±‚åœ¨ç·šç©å®¶æŠ•ç¥¨é–‹é€šã€‚\n");

        if( query("doing", me) == "scheme"){
                if( query("jing", me)<100 )
                        return notify_fail("ä½ ç¾åœ¨çš„ç²¾ç¥ä¸æ¿Ÿï¼Œç­‰ä¸€æœƒå…’å§ã€‚\n");
                addn("jing", -50, me);
        }

        if (me->is_character() && living(me))
        {
                if( time()-query_temp("last_use_channel", me)<4){
                        if( query_temp("last_message", me) == arg )
                                return notify_fail("ä¸è¦åœ¨çŸ­æœŸå…§ä½¿ç”¨é »é“"
                                                   "ç™¼å¸ƒé‡å¾©çš„ä¿¡æ¯ã€‚\n");
                        set_temp("last_message", arg, me);
                } else {
                        set_temp("last_message", arg, me);
                        set_temp("last_use_channel", time(), me);
                }

                switch (channels[verb]["only"])
                {
                case "imm":
                        if( wiz_level(me) < 1 )
                                return 0;
                        break;

                case "wiz":
                        if( wiz_level(me) < 3 )
                                return 0;
                        break;

                case "arch":
                        if( wiz_level(me) < 4 )
                                return 0;
                        break;
                case "sys" :
                        if( playerp(me) )
                                return 0;
                        break;

                case "party":
                        if( !(party=query("bunch/bunch_name", me)) )
                                return notify_fail("ä½ é‚„æ˜¯å…ˆåŠ å…¥ä¸€å€‹å¹«æ´¾å†èªªå§ã€‚\n");

                        if( strlen(party) == 4 ) {
                                party = party[0..1] + " â–¡ " +
                                        party[2..3];
                        }

                        if( strlen(party) == 6 ) {
                                party = party[0..1] + " " +
                                        party[2..3] + " " +
                                        party[4..5];
                        }
                        channels[verb]["msg_speak"] = HIG "ã€" + party +
                                                      "ã€‘%sï¼š%s\n" NOR;
                        channels[verb]["msg_emote"] = HIG "ã€" + party +
                                                      "ã€‘%s" NOR;
                        break;

                case "bt":
                        if( !(bt=query_temp("battle/team_name", me)) )
                                return notify_fail("ä½ é‚„æ˜¯å…ˆåƒåŠ æˆ°å ´å†èªªå§ã€‚\n");

                        if( strlen(bt) == 4 ) {
                                bt = bt[0..1] + " â–¡ " +
                                     bt[2..3];
                        }

                        if( strlen(bt) == 6 ) {
                                bt = bt[0..1] + " " +
                                     bt[2..3] + " " +
                                     bt[4..5];
                        }
                        channels[verb]["msg_speak"] = HIG "ã€" + bt +
                                                      "ã€‘%sï¼š%s\n" NOR;
                        channels[verb]["msg_emote"] = HIG "ã€" + bt +
                                                      "ã€‘%s" NOR;
                        break;
                        
                case "family":
                        if( !(family=query("family/family_name", me)) )
                                return notify_fail("ä½ é‚„æ˜¯å…ˆåŠ å…¥ä¸€å€‹é–€æ´¾å†èªªå§ã€‚\n");

                        if( strlen(family) == 4 ) {
                                family = family[0..1] + " â–¡ " +
                                         family[2..3];
                        }

                        if( strlen(family) == 6 ) {
                                family = family[0..1] + " " +
                                         family[2..3] + " " +
                                         family[4..5];
                        }
                        channels[verb]["msg_speak"] = HIG "ã€" + family +
                                                      "ã€‘%sï¼š%s\n" NOR;
                        channels[verb]["msg_emote"] = HIG "ã€" + family +
                                                      "ã€‘%s" NOR;
                        break;
                }
        }

        if( verb == "shout" ) {
                if( !arg ) return notify_fail("ä½ æƒ³è¦å¤§å«ä»€éº¼ï¼Ÿ\n");

                if( !wizardp(me) )
                        return notify_fail("ä½ ä¸æ˜¯å·«å¸«ï¼Œç„¡æ³•å–Šå‡ºé‚£éº¼å¤§çš„è²éŸ³ã€‚\n");

                who = me->name(1) + "[" + query("id", me) + "]";
                msg = sprintf(channels[verb]["msg_speak"], who, arg);
                // msg = HIW + me->name(1) + "ç¸±è²é•·å˜¯ï¼š" + arg + "\n" + NOR;
                shout(msg);
                write(HIW + "ä½ ç¸±è²é•·å˜¯ï¼š" + arg + "\n" + NOR);
                channel_log(msg, verb, me);
                users()->add_msg_log(verb, msg + "\n");
                return 1;
        }

        // If we speaks something in this channel, then must tune it in.
        if( playerp(me) ) {
                if( !pointerp(tuned_ch=query("channels", me))){
                        set("channels", ({verb}), me);
                        write("ä½ æ‰“é–‹äº†" + channels[verb]["name"] + "é »é“ã€‚\n");
                } else
                if( member_array(verb, tuned_ch) == -1 ) {
                        set("channels", tuned_ch+({verb}), me);
                        write("ä½ æ‰“é–‹äº†" + channels[verb]["name"] + "é »é“ã€‚\n");
                }

                if( channels[verb]["for_listen"] ) {
                        write("é€™å€‹é »é“åªèƒ½ç”¨ä¾†è½å–ä¿¡æ¯ã€‚\n");
                        return 1;
                }
        }

        // Support of channel emote
        if( emote  && me->is_character() ) {
                string vb, emote_arg, mud;

                if( undefinedp(channels[verb]["msg_emote"]) )
                        return notify_fail("é€™å€‹é »é“ä¸æ”¯æŒè¡¨æƒ…å‹•è©ã€‚\n");

                if( sscanf(arg, "%s %s", vb, emote_arg) != 2 ) {
                        vb = arg;
                        emote_arg = "";
                }

                // internet channel emote
                if( channels[verb]["intermud_emote"] ) {
                        if( sscanf(emote_arg, "%s@%s", emote_arg, mud) == 2 &&
                            htonn(mud) != mud_nname() ) {
                                REMOTE_Q->send_remote_q(mud,verb,query("id", me),emote_arg,vb);
                                write("ç¶²è·¯è¨Šæ¯å·²é€å‡ºï¼Œè«‹ç¨å€™ã€‚\n");
                                return 1;
                        }

                        local=sprintf("%s(%s@%s)",me->name(1),capitalize(query("id", me)),
                                                     upper_case(MUD_INTERMUD_NAME));
                        imsg = EMOTE_D->do_emote(me, vb, emote_arg, 3, local,
                                                 channels[verb]["msg_color"]);
                        if( stringp(imsg) )
                                arg = replace_string(imsg, local, me->name());
                        else
                                arg = 0;
                }
                else if( verb == "rumor" && random(10) < 7 )
                        arg = EMOTE_D->do_emote(me, vb, emote_arg, 2,
                                        channels[verb]["anonymous"],
                                        channels[verb]["msg_color"]);
                else    arg = EMOTE_D->do_emote(me, vb, emote_arg, 1,
                                        0, channels[verb]["msg_color"]);

                if( !arg && emote == 2 )
                        arg = (channels[verb]["anonymous"] ? channels[verb]["anonymous"]
                                                           : me->name(channels[verb]["name_raw"])) +
                                                             vb + "\n";
                if( !arg )
                        return 0;
        }

        if( myemote && me->is_character() ) {
                if( undefinedp(channels[verb]["msg_emote"]) )
                        return notify_fail("é€™å€‹é »é“ä¸æ”¯æŒè‡ªå®šç¾©è¡¨æƒ…ã€‚\n");

                // internet channel emote
                if( channels[verb]["intermud_emote"] )
                        return notify_fail("é€™å€‹é »é“ä¸æ”¯æŒè‡ªå®šç¾©è¡¨æƒ…ã€‚\n");

                if( stringp(arg) &&
                    ((strsrch(arg, "[") != -1) ||
                     (strsrch(arg, "]") != -1)) )
                        return notify_fail("é€™å€‹é »é“ç¦æ­¢ä½¿ç”¨â€˜[â€™ã€â€˜]â€™ç­‰å­—ç¬¦ã€‚\n");
        }

        if( channels[verb]["anonymous"] && ( !playerp(me) || emote || check_bad_words(me, arg)) ) {
                who = channels[verb]["anonymous"];
        } else
        if( is_player || !stringp(who=query("channel_id", me))){
                who = me->name(channels[verb]["name_raw"]);
                if( !stringp(who) ) who = me->query_name();
                if( who == me->name(1) )
                        who += channels[verb]["msg_color"] +
                               "[" + capitalize(query("id", me)) + "]";
                else if( is_player || me->is_baby() )
                        do_channel(this_object(),"sys",sprintf(HIW"%s(%s)"HIW"æ‰®%s"HIW"ï¼",me->name(1),query("id", me),me->name()));
                if( who[0] == 27 ) who = NOR + who;
                who += channels[verb]["msg_color"];
        }

        // Ok, now send the message to those people listening us.
        obs = all_interactive();
        if (stringp(channels[verb]["only"]))
                obs = filter_array(obs, (: filter_listener :),
                                   channels[verb]["only"], me);

        //if( !stringp(arg) || arg == "" || arg == " " )
        arg = arg || (emote ? "çœ‹èµ·ä¾†è¡¨æƒ…è±å¯Œã€‚" : "..." );

        if( emote ) {
                string localmsg = arg;
                string ecol = channels[verb]["msg_color"];
                if( emote == 2 && !arg )
                        arg = me->name(channels[verb]["name_raw"]) +
                              ecol+"["+query("id", me)+"@"+
                              MUD_INTERMUD_NAME + "]" + arg;
                if( !stringp(arg) ) return 0;

                if( channels[verb]["msg_emote"] )
                        localmsg = remove_addresses(arg, 0); // 98-1-22 14:30

                if( channels[verb]["omit_address"] )
                        localmsg = remove_addresses(arg, 1);
                else if( channels[verb]["intermud_emote"] )
                        localmsg = remove_addresses(arg, 0);

                if( !stringp(localmsg) ) return 0;
                msg = sprintf(channels[verb]["msg_emote"],
                              sprintf(localmsg, ecol, ecol, ecol));
        } else if( myemote ) {
                if( channels[verb]["anonymous"] && !playerp(me) )
                        arg = channels[verb]["anonymous"] + arg + "\n";
                else
                        arg=query("name", me)+arg+"\n";
                msg = sprintf(channels[verb]["msg_emote"], arg);
        } else {
                // ç‰¹æ®Šè™•ç†channel_broadcastä¿¡æ¯é¡¯ç¤º
                if( me == this_object() ) {
                        msg = sprintf(channels[verb]["msg_speak"], "", arg);
                        msg = replace_string(msg, "ï¼š", "");
                }
                else
                        msg = sprintf(channels[verb]["msg_speak"], who, arg);
        }

        if( channels[verb]["anonymous"] && (playerp(me) || me->is_baby()) ) {
                do_channel(this_object(), "sys",
                           sprintf("%s(%s)æ­£åœ¨å‘%sé »é“ç™¼å‡ºä¿¡æ¯ã€‚",
                              query("name", me),query("id", me),verb));
                SPECIAL_NPC->receive_report(me, verb);
        }

        tobs = filter_array(obs, (: query_temp("tomud", $1) :));
        pobs = obs - tobs;
        message("channel:" + ((verb == "ultra") ? "chat" : verb), msg, pobs);
        msg = replace_string(msg, "\n[2;37;0m", "");
        msg += NOR;
        message("channel:" + ((verb == "ultra") ? "chat" : verb), msg, tobs);
        channel_log(msg, verb, me);
        obs->add_msg_log(verb, msg + "\n");

        if( (playerp(me) || me->is_baby()) && !emote && !check_bad_words(me, msg) )
        {
                if( !query("badwords", me) || query("badwords", me)<2 )
                {
                        me->ban_say_until(60, "ç”±äºä½ è¨€èªä¸­å¸¶æœ‰æ±¡ç©¢è¨€è©ï¼Œä½ æ‰€æœ‰å…¬é–‹èŠå¤©é »é“æš«æ™‚è¢«é—œé–‰");

                        message("channel:chat",
                                        HIR"ã€ç³»çµ±é€šå‘Šã€‘ç©å®¶"+query("name", me)+
                                        "è¨€èªä¸­å¸¶æœ‰æ±¡ç©¢è¨€è©ï¼Œæš«æ™‚é—œé–‰å…¶æ‰€æœ‰å…¬é–‹èŠå¤©é »é“ï¼Œä¸¦è¨˜éŒ„åœ¨æ¡ˆï¼\n" NOR, users());
                        addn("badwords", 1, me);
                }
                else
                {
                        message("channel:chat",
                                        HIR"ã€ç³»çµ±é€šå‘Šã€‘ç©å®¶"+query("name", me)+
                                        "é€£çºŒä¸‰æ¬¡è¨€èªä¸­å¸¶æœ‰æ±¡ç©¢è¨€è©ï¼Œè¢«æš«æ™‚ç›£ç¦ï¼Œä¸¦è¨˜éŒ„åœ¨æ¡ˆï¼Œç­‰å€™è™•ç†ï¼\n" NOR, users());
                        delete("badwords", me);
                        me->get_into_prison(0, 0, 180);
                }
        }

        if( arrayp(channels[verb]["extra_listener"]) ) {
                channels[verb]["extra_listener"] -= ({ 0 });
                if( sizeof(channels[verb]["extra_listener"]) )
                        channels[verb]["extra_listener"]->relay_channel(me, verb, arg);
        }

        if( !undefinedp(channels[verb]["intermud"]) && me->is_character() ) {
                channels[verb]["intermud"]->send_msg(channels[verb]["intermud_channel"],
                                                     query("id", me),me->name(1),
                                                     imsg ? imsg : arg, emote,
                                                     channels[verb]["filter"]);
        }

        return 1;
}

int filter_listener(object ppl, string only, object me)
{
        // Don't bother those in the login limbo.
        //if ( !environment(ppl) ) return 0;

        switch (only)
        {
        case "imm":
                return (wiz_level(ppl) >= 1);

        case "arch":
                return (wiz_level(ppl) >= 4);

        case "wiz":
                return (wiz_level(ppl) >= 3);

        case "sys":
                return 1;

        case "family":
                return (wizardp(ppl) || query("family/family_name", ppl) == query("family/family_name", me));

        case "bt":
                return (wizardp(ppl) || query_temp("battle/team_name", ppl) == query_temp("battle_team_name", me));
                
        case "party":
                return (wizardp(ppl) || query("bunch/bunch_name", ppl) == query("bunch/bunch_name", me));

        case "league":
                return (wizardp(ppl) || query("league/league_name", ppl) == query("league/league_name", me));
        }

        return 1;
}

void register_relay_channel(string channel)
{
        object ob;
        ob = previous_object();

        if( undefinedp(channels[channel]) || !ob )
                return;
        if( arrayp(channels[channel]["extra_listener"]) ) {
                if( member_array(ob, channels[channel]["extra_listener"]) >= 0 )
                        return;
                channels[channel]["extra_listener"] += ({ ob });
        }
        else    channels[channel]["extra_listener"] = ({ ob });
}

string remove_addresses(string msg, int all)
{
        int i;
        mixed tmp;
        string pattern;

        if( !stringp(msg) ) return msg;
        if( all )
                pattern = "[(][A-Za-z]+@[a-zA-Z]+[0-9]+[.]?[)]";
        else
                pattern = "[(][A-Za-z]+@" + MUD_INTERMUD_NAME + "[)]";

        tmp = reg_assoc(msg, ({ pattern }), ({ 1 }));

        if( !arrayp(tmp) ) return msg;
        msg = "";
        for( i=0; i<sizeof(tmp[0]); i++ )
                if( tmp[1][i] == 0 ) msg += tmp[0][i];
        return msg;
}

protected int check_bad_words(object user, string msg)
{
        int i;
        string old_msg = msg;

        msg = replace_string(msg,"ç›Šæ©Ÿ","");
        msg = replace_string(msg,"ç·™çµ²","");
        msg = replace_string(msg,"è¦é‚„","");
        msg = replace_string(msg,"ï½","a");
        msg = replace_string(msg,"ï½‚","b");
        msg = replace_string(msg,"ï½ƒ","c");
        msg = replace_string(msg,"ï½„","d");
        msg = replace_string(msg,"ï½…","e");
        msg = replace_string(msg,"ï½†","f");
        msg = replace_string(msg,"ï½‡","g");
        msg = replace_string(msg,"ï½ˆ","h");
        msg = replace_string(msg,"ï½‰","i");
        msg = replace_string(msg,"ï½Š","j");
        msg = replace_string(msg,"ï½‹","k");
        msg = replace_string(msg,"ï½Œ","l");
        msg = replace_string(msg,"ï½","m");
        msg = replace_string(msg,"ï½","n");
        msg = replace_string(msg,"ï½","o");
        msg = replace_string(msg,"ï½","p");
        msg = replace_string(msg,"ï½‘","q");
        msg = replace_string(msg,"ï½’","r");
        msg = replace_string(msg,"ï½“","s");
        msg = replace_string(msg,"ï½”","t");
        msg = replace_string(msg,"ï½•","u");
        msg = replace_string(msg,"ï½–","v");
        msg = replace_string(msg,"ï½—","w");
        msg = replace_string(msg,"ï½˜","x");
        msg = replace_string(msg,"ï½™","y");
        msg = replace_string(msg,"ï½š","z");
/*
        msg = lower_case(msg);
        msg = replace_string(msg,",","");
        msg = replace_string(msg,".","");
        msg = replace_string(msg,";","");
        msg = replace_string(msg,"ï¼Œ","");
        msg = replace_string(msg,"ã€‚","");
        msg = replace_string(msg,"ï¼›","");
        msg = replace_string(msg," ","");
        msg = replace_string(msg,"â–¡","");
        msg = replace_string(msg,"'","");
        msg = replace_string(msg,"\"","");
        msg = replace_string(msg,"â€","");
        msg = replace_string(msg,"â€œ","");
        msg = replace_string(msg,"[","");
        msg = replace_string(msg,"]","");
        msg = replace_string(msg,"ã€","");
        msg = replace_string(msg,"ã€","");
        msg = replace_string(msg,"ã€","");
        msg = replace_string(msg,"ã€‘","");
        msg = replace_string(msg,"â€™","");
        msg = replace_string(msg,"â€˜","");
*/

        for( i = 0; i < sizeof(bad_words);i ++ )
        {
                if( strsrch(msg, bad_words[i]) != -1 )
                {
                        log_file("channel/bad_word",sprintf("%s(%s)äº%sæ¶‰å«Œè¬›è‡Ÿè©±ï¼š\n%s-->%s\n",
                                                             user->name(1),
                                                             query("id", user),
                                                             ctime(time()),
                                                             filter_color(old_msg),
                                                             bad_words[i]) );
                        return 0;
                }
        }
        return 1;
}

varargs void channel_broadcast(string channel, string msg, mixed arg)
{
        if( undefinedp(arg) )
                do_channel(this_object(), channel, msg);
        else if( objectp(arg) )
                do_channel(arg, channel, msg);
        else
                do_channel(this_object(), channel, msg, arg);
}
