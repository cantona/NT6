// meng-zhu.c 武林盟主
// colored the title of 武林盟主(player) ,   ReyGod, 1/15/1997
#include <ansi.h>

#ifndef NPCDATA
#define NPCDATA "/data/npc/"
#endif
#define MENGZHU NPCDATA + "meng-zhu"

inherit NPC;
inherit F_MASTER;
inherit F_CLEAN_UP;
inherit F_UNIQUE;
inherit F_SAVE;

string query_save_file()
{
        return MENGZHU;
}

void create()
{
        seteuid(getuid());

        if (!restore()) {
        set_name("魏無雙", ({ "wulin mengzhu", "mengzhu", "zhu" }) );
        set("title", "武林盟主" );
        set("gender", "男性" );
        set("age", 40);
      set("long","他就是雄踞武林，號召天下，威風赫赫的當今武林盟主。\n");
        set("attitude", "heroism");
        set("generation",0);
        set("winner","none");

        set("str", 25);
        set("con", 25);
        set("int", 25);
        set("dex", 25);

        set("max_qi", 500);
        set("eff_qi", 500);
        set("qi", 500);
        set("max_jing", 300);
        set("jing", 300);
        set("neili", 500);
        set("max_neili", 500);
        set("jiali", 40);
        set("shen_type", 0);

        set("no_clean_up",1);
        set("combat_exp", 500000);

        set_skill("force",  100);
        set_skill("unarmed",100);
        set_skill("sword",  100);
        set_skill("dodge",  100);
        set_skill("parry",  100);

        set("weapon", "/d/shaolin/obj/changjian");
        set("armor", "/d/city/obj/cloth");

        setup();

        carry_object("/d/shaolin/obj/changjian")->wield();
        carry_object("/d/city/obj/cloth")->wear();
        }
        else {
                set("id", "mengzhu");
                set_name(query("name"), ({ query("id") }));
                setup();
                if( query("weapon", query("weapon", this_object()))carry_object(this_object()))->wield();
                if( query("armor", query("armor", this_object()))carry_object(this_object()))->wear();
        }
}

void init()
{
        object me = this_object();

        add_action("do_recopy",  "recopy");
        add_action("do_recover", "recover");
        add_action("do_kill", "kill");

}

int do_kill()
{
        object ob;
        int i;

        command("say 你想謀害本盟主，當真是吃了熊心豹子膽了！！");
        command("say 座下白衣武士何在！");

        message_vision("四周的白衣武士群起對$N發動攻擊！\n", this_player());

        for(i=0; i<4; i++) {
                if( objectp( ob = present("wei shi " + (i+1), environment(this_object())) ) )
                                 ob->kill_ob(this_player());
                else        this_object()->kill_ob(this_player());
        }

        return 1;
}

int accept_fight(object ob)
{
        object me  = this_object();

        if( query("winner", me) == query("id", ob) )
{                remove_call_out("do_copy");
                call_out("do_copy", 1, me, ob);
                return notify_fail("你跟你自己打什麼架？！\n");
}

        if (wizardp(this_player()))
                return notify_fail("巫師不能搶盟主之位！\n");

        if ( me->is_fighting() )
                return notify_fail("已經有人正在挑戰武林盟主！\n");

        set("eff_qi",query("max_qi",  me), me);
        set("qi",query("max_qi",  me), me);
        set("jing",query("max_jing",  me), me);
        set("neili",query("max_neili",  me), me);

        remove_call_out("checking");
        call_out("checking", 1, me, ob);

        return 1;
}

int checking(object me, object ob)
{

        object obj;
        int my_max_qi, his_max_qi;

        my_max_qi=query("max_qi", me);
        his_max_qi=query("max_qi", ob);

        if (me->is_fighting()) {
                if( (query("qi", me)*100/my_max_qi) <= 80 )
                        command("exert recover");

                call_out("checking", 1, me, ob);
                return 1;
        }

        if ( !present(ob, environment()) ) return 1;

        if( (query("qi", me)*100/my_max_qi) <= 50){
                command("say 果然厲害，恭喜你成為當今武林盟主！\n");
                command("chat 哈哈哈，到底是長江後浪推前浪，一代新人換舊人！\n");
                command("chat恭喜"+query("name", ob)+"被推舉為當今武林盟主！\n");
                remove_call_out("do_copy");
                call_out("do_copy", 1, me, ob);
                return 1;
        }

        if( (query("qi", ob)*100/his_max_qi)<50){
                command("say 看來" + RANK_D->query_respect(ob) +
                        "還得多加練習，方能在當今武林中出人頭地 !\n");
                return 1;
        }

        return 1;
}

int do_copy(object me, object ob)
{
        object ob1, ob2;
        string mengzhu, shangshan, fae;

        seteuid(getuid());

        set("winner",query("id",  ob), me);
        addn("generation", 1, me);

        set("name",query("name",  ob), me);
        set("title", "第"+chinese_number(query("generation", me))+"代武林盟主", me);
        set(query("id", "short", HIR+query("title", me)+NOR+""+query("name", me)+"("+capitalize(ob))+")", me);
        delete("title", me);

        delete_temp("apply/short", ob);
        set_temp("apply/short", ({me->short()}), ob);
// --record which mengzhu generataion this player got-------by ReyGod
// = better to place this checking when players login.
//        ob->set("mengzhu_gen",me->query("generation"));

        set("title", "第"+chinese_number(query("generation", me))+"代武林盟主", me);
        set("short",query("title",  me)+""+query("name", me)+"(Wulinmengzhu)", me);
        delete("title", me);

        if(!( ob1 = find_living("shangshan")) )
        ob1 = load_object("/clone/npc/shang-shan");
        shangshan=query("winner", ob1);

        if(!( ob2 = find_living("fae")) )
        ob2 = load_object("/clone/npc/fa-e");
        fae=query("winner", ob1);

        if( query("id", ob) == shangshan){
                rm( ob1->query_save_file() + SAVE_EXTENSION );
                destruct(ob1);
        }
        else if( query("id", ob) == fae){
                rm( ob2->query_save_file() + SAVE_EXTENSION );
                destruct(ob2);
        }

        remove_call_out("do_clone");
        call_out("do_clone", 0, me, ob);

        return 1;
}

int do_recopy(object me, object ob)
{
        me = this_object();
        ob = this_player();

        if( query("winner", me) != query("id", ob) )
                return notify_fail("你不是現任武林盟主！\n");;

        set("name",query("name",  ob), me);
        set("title", "第"+chinese_number(query("generation", me))+"代武林盟主", me);
        set(query("id", "short", HIR+query("title", me)+NOR+""+query("name", me)+"("+capitalize(ob))+")", me);
        delete("title", me);

        delete_temp("apply/short", ob);
        set_temp("apply/short", ({me->short()}), ob);
// --record which mengzhu generataion this player got-------by ReyGod
// = better to place this checking when players login.
//        ob->set("mengzhu_gen",me->query("generation"));


        set("title", "第"+chinese_number(query("generation", me))+"代武林盟主", me);
        set("short",query("title",  me)+""+query("name", me)+"(Wulinmengzhu)", me);
        delete("title", me);

        remove_call_out("do_clone");
        call_out("do_clone", 0, me, ob);

        return 1;
}

int do_clone(object me, object ob)
{
        object *inv, news;
        mapping hp_status, skill_status, map_status, prepare_status;
        string *sname, *mname, *pname;
        int i, temp;

        seteuid( geteuid(me) );

/* delete and copy skills */

        if ( mapp(skill_status = me->query_skills()) ) {
                skill_status = me->query_skills();
                sname  = keys(skill_status);

                temp = sizeof(skill_status);
                for(i=0; i<temp; i++) {
                        me->delete_skill(sname[i]);
                }
        }

        if ( mapp(skill_status = ob->query_skills()) ) {
                skill_status = ob->query_skills();
                sname  = keys(skill_status);

                for(i=0; i<sizeof(skill_status); i++) {
                        me->set_skill(sname[i], skill_status[sname[i]]);
                }
        }

/* delete and copy skill maps */

        if ( mapp(map_status = me->query_skill_map()) ) {
                mname  = keys(map_status);

                temp = sizeof(map_status);
                for(i=0; i<temp; i++) {
                        me->map_skill(mname[i]);
                }
        }

        if ( mapp(map_status = ob->query_skill_map()) ) {
                mname  = keys(map_status);

                for(i=0; i<sizeof(map_status); i++) {
                        me->map_skill(mname[i], map_status[mname[i]]);
                }
        }

/* delete and copy skill prepares */

        if ( mapp(prepare_status = me->query_skill_prepare()) ) {
                pname  = keys(prepare_status);

                temp = sizeof(prepare_status);
                for(i=0; i<temp; i++) {
                        me->prepare_skill(pname[i]);
                }
        }

        if ( mapp(prepare_status = ob->query_skill_prepare()) ) {
                pname  = keys(prepare_status);

                for(i=0; i<sizeof(prepare_status); i++) {
                        me->prepare_skill(pname[i], prepare_status[pname[i]]);
                }
        }

/* unwield and remove weapon & armor */

        inv = all_inventory(me);
        for(i=0; i<sizeof(inv); i++) {
                destruct(inv[i]);
        }
        set("weapon", 0);
        set("armor", 0);

/* wield and wear weapon & armor */

        inv = all_inventory(ob);
        for(i=0; i<sizeof(inv); i++) {
                if( query("weapon_prop/damage", inv[i])>100
                 || query("armor_prop/armor", inv[i])>100)continue;

                if( query("weapon_prop", inv[i]) && query("equipped", inv[i])){
                        carry_object(base_name(inv[i]))->wield();
                        set("weapon", base_name(inv[i]), me);
                }
                else if( query("armor_prop", inv[i]) && query("equipped", inv[i])){
                        carry_object(base_name(inv[i]))->wear();
                        set("armor", base_name(inv[i]), me);
                }
        }

/* copy entire dbase values */

        hp_status = ob->query_entire_dbase();

                set("str", hp_status["str"], me);
                set("int", hp_status["int"], me);
                set("con", hp_status["con"], me);
                set("dex", hp_status["dex"], me);
                set("age", hp_status["age"], me);

                set("max_qi", hp_status["max_qi"], me);
                set("eff_qi", hp_status["eff_qi"], me);
                set("qi", hp_status["qi"], me);
                set("max_jing", hp_status["max_jing"], me);
                set("eff_jing", hp_status["eff_jing"], me);
                set("jing", hp_status["jing"], me);
                set("max_neili", hp_status["max_neili"], me);
                set("neili", hp_status["neili"], me);
                set("jiali", hp_status["jiali"], me);
                set("gender", hp_status["gender"], me);
                set("combat_exp", hp_status["combat_exp"], me);

        save();

        tell_object(ob, "狀態儲存完畢。\n");

        news = new("/clone/npc/meng-zhu");
        news->move("/d/taishan/fengchan");
        destruct(me);

        return 1;
}

int do_recover()
{
        object me, ob;
        mapping skill_status, map_status, prepare_status;
        string *sname, *mname, *pname;
        int i;

        me = this_object();
        ob = this_player();

        if( query("winner", me) != query("id", ob) )
                return notify_fail("你不是現任武林盟主！\n");;

/* delete and copy skills */

        if ( mapp(skill_status = ob->query_skills()) ) {
                sname  = keys(skill_status);

                for(i=0; i<sizeof(skill_status); i++) {
                        ob->delete_skill(sname[i]);
                }
        }

        if ( mapp(skill_status = me->query_skills()) ) {
                sname  = keys(skill_status);

                for(i=0; i<sizeof(skill_status); i++) {
                        ob->set_skill(sname[i], skill_status[sname[i]]);
                }
        }

/* delete and copy skill maps */

        if ( mapp(map_status = ob->query_skill_map()) ) {
                mname  = keys(map_status);

                for(i=0; i<sizeof(map_status); i++) {
                        ob->map_skill(mname[i]);
                }
        }

        if ( mapp(map_status = me->query_skill_map()) ) {
                mname  = keys(map_status);

                for(i=0; i<sizeof(map_status); i++) {
                        ob->map_skill(mname[i], map_status[mname[i]]);
                }
        }

/* delete and copy skill prepares */

        if ( mapp(prepare_status = ob->query_skill_prepare()) ) {
                pname  = keys(prepare_status);

                for(i=0; i<sizeof(prepare_status); i++) {
                        ob->prepare_skill(pname[i]);
                }
        }

        if ( mapp(prepare_status = me->query_skill_prepare()) ) {
                pname  = keys(prepare_status);

                for(i=0; i<sizeof(prepare_status); i++) {
                        ob->prepare_skill(pname[i], prepare_status[pname[i]]);
                }
        }

/* copy combat exp values */

        set("combat_exp",query("combat_exp",  me), ob);

        write("狀態復元完畢。\n");

        return 1;
}
